<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Title</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/css/materialize.min.css">
    <!-- 실행: npm run dev -->
    <script src="https://unpkg.com/blockly/blockly.min.js"></script>
    <script>
        Blockly.Blocks['discord_send'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("채널:");
                this.appendValueInput("channel")
                    .setCheck(null);
                this.appendDummyInput()
                    .appendField("에 메시지:");
                this.appendValueInput("message")
                    .setCheck(null);
                this.appendDummyInput()
                    .appendField("보내기");
                this.setInputsInline(true);
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(240);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };
        Blockly.JavaScript['discord_send'] = function (block) {
            var value_channel = Blockly.JavaScript.valueToCode(block, 'channel', Blockly.JavaScript.ORDER_ATOMIC);
            var value_message = Blockly.JavaScript.valueToCode(block, 'message', Blockly.JavaScript.ORDER_ATOMIC);
            // TODO: Assemble JavaScript into code variable.
            var code = `client.channels.get(${value_channel}.id).send(${value_message})`;
            return code;
        };
        Blockly.Blocks['event_message'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("메시지가 수신되었을 때");
                this.appendDummyInput()
                    .appendField("메시지 변수 :")
                    .appendField(new Blockly.FieldVariable("message"), "NAME");
                this.appendStatementInput("NAME")
                    .setCheck(null);
                this.setColour(240);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };
        Blockly.JavaScript['event_message'] = function (block) {
            var variable_name = Blockly.JavaScript.nameDB_.getName(block.getFieldValue('NAME'), Blockly.Variables.NAME_TYPE);
            var statements_name = Blockly.JavaScript.statementToCode(block, 'NAME');
            // TODO: Assemble JavaScript into code variable.
            var code = `client.on('message', (message) => {
    ${variable_name} = message
    ${statements_name}
    })\n`
            return code;
        };
        Blockly.Blocks['event_ready'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("봇 연결에 성공했을 때");
                this.appendStatementInput("NAME")
                    .setCheck(null);
                this.setColour(240);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };
        Blockly.JavaScript['event_ready'] = function (block) {
            var statements_name = Blockly.JavaScript.statementToCode(block, 'NAME');
            // TODO: Assemble JavaScript into code variable.
            var code = `client.on('ready', () => {
    ${statements_name}
    })\n`
            return code;
        };
        Blockly.Blocks['event_memin'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("멤버가 들어왔을 때");
                this.appendDummyInput()
                    .appendField("멤버 변수 :")
                    .appendField(new Blockly.FieldVariable("memberin"), "NAME");
                this.appendStatementInput("NAME")
                    .setCheck(null);
                this.setColour(240);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };
        Blockly.JavaScript['event_memin'] = function (block) {
            var statements_name = Blockly.JavaScript.statementToCode(block, 'NAME');
            // TODO: Assemble JavaScript into code variable.
            var code = `client.on('guildMemberAdd', memberin => {
    ${statements_name}
    })\n`
            return code;
        };
        Blockly.Blocks['event_memout'] = {
            init: function () {
                this.appendDummyInput()
                    .appendField("멤버가 들어왔을 때");
                this.appendDummyInput()
                    .appendField("멤버 변수 :")
                    .appendField(new Blockly.FieldVariable("memberout"), "NAME");
                this.appendStatementInput("NAME")
                    .setCheck(null);
                this.setColour(240);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };
        Blockly.JavaScript['event_memout'] = function (block) {
            var statements_name = Blockly.JavaScript.statementToCode(block, 'NAME');
            // TODO: Assemble JavaScript into code variable.
            var code = `client.on('guildMemberAdd', memberout => {
    ${statements_name}
    })\n`
            return code;
        };
        Blockly.Blocks['startswith'] = {
            init: function () {
                this.appendValueInput("first")
                    .setCheck(null)
                    .setAlign(Blockly.ALIGN_RIGHT)
                    .appendField("");
                this.appendDummyInput()
                    .appendField("가");
                this.appendValueInput("second")
                    .setCheck(null)
                    .setAlign(Blockly.ALIGN_RIGHT)
                    .appendField("");
                this.appendDummyInput()
                    .appendField("로 시작하는가?");
                this.setInputsInline(true);
                this.setOutput(true, null);
                this.setColour(240);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };
        Blockly.JavaScript['startswith'] = function (block) {
            var value_first = Blockly.JavaScript.valueToCode(block, 'first', Blockly.JavaScript.ORDER_ATOMIC);
            var value_second = Blockly.JavaScript.valueToCode(block, 'second', Blockly.JavaScript.ORDER_ATOMIC);
            // TODO: Assemble JavaScript into code variable.
            var code = `${value_first}.startsWith(${value_second})`;
            return [code, Blockly.JavaScript.ORDER_NONE];
        };
        Blockly.Blocks['discoding_message'] = {
            init: function () {
                this.appendValueInput("NAME")
                    .setCheck(null)
                    .appendField("메시지:");
                this.appendDummyInput()
                    .appendField(new Blockly.FieldDropdown([["의 내용", "content"], ["의 ID", "id"], ["를 쓴 사용자", "author"], ["를 받은 채널", "channel"], ["가 고정되어 있는가?", "pin"], ["시스템 메시지인가?", "system"]]), "NAME");
                this.setInputsInline(true);
                this.setOutput(true, null);
                this.setColour(240);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };
        Blockly.JavaScript['discoding_message'] = function (block) {
            var value = Blockly.JavaScript.valueToCode(block, 'NAME', Blockly.JavaScript.ORDER_ATOMIC);
            var select = block.getFieldValue('NAME');
            // TODO: Assemble JavaScript into code variable.
            var code = '...';
            // TODO: Change ORDER_NONE to the correct strength.
            if (select == 'content')
                var code = `${value}.content`;
            else if (select == 'id')
                var code = `${value}.id`;
            else if (select == 'author')
                var code = `${value}.author`;
            else if (select == 'channel')
                var code = `${value}.channel`;
            else if (select == 'pin')
                var code = `${value}.pinned`;
            else if (select == 'system')
                var code = `${value}.system`;
            return [code, Blockly.JavaScript.ORDER_NONE];
        };
        Blockly.Blocks['discoding_user'] = {
            init: function () {
                this.appendValueInput("value")
                    .setCheck(null)
                    .appendField("사용자:");
                this.appendDummyInput()
                    .appendField(new Blockly.FieldDropdown([["의 ID", "id"], ["의 닉네임", "username"], ["가 봇인가?", "bot"]]), "NAME");
                this.setInputsInline(true);
                this.setOutput(true, null);
                this.setColour(240);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };
        Blockly.JavaScript['discoding_user'] = function (block) {
            var value = Blockly.JavaScript.valueToCode(block, 'value', Blockly.JavaScript.ORDER_ATOMIC);
            var select = block.getFieldValue('NAME');
            // TODO: Assemble JavaScript into code variable.
            if (select == 'username')
                var code = `${value}.username`;
            else if (select == 'id')
                var code = `${value}.id`;
            else if (select == 'bot')
                var code = `${value}.bot`;
            // TODO: Change ORDER_NONE to the correct strength.
            return [code, Blockly.JavaScript.ORDER_NONE];
        };
        Blockly.Blocks['discord_edit'] = {
            init: function () {
                this.appendValueInput("message")
                    .setCheck(null)
                    .appendField("메시지:");
                this.appendValueInput("edit")
                    .setCheck(null)
                    .appendField("를");
                this.appendDummyInput()
                    .appendField("로 수정하기");
                this.setInputsInline(true);
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(240);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };
        Blockly.JavaScript['discord_edit'] = function (block) {
            var value_message = Blockly.JavaScript.valueToCode(block, 'message', Blockly.JavaScript.ORDER_ATOMIC);
            var value_edit = Blockly.JavaScript.valueToCode(block, 'edit', Blockly.JavaScript.ORDER_ATOMIC);
            // TODO: Assemble JavaScript into code variable.
            var code = `${value_message}.edit(${value_edit})\n`;
            return code;
        };
        Blockly.Blocks['discord_delete'] = {
            init: function () {
                this.appendValueInput("message")
                    .setCheck(null)
                    .appendField("메시지:");
                this.appendDummyInput()
                    .appendField("삭제하기");
                this.setInputsInline(true);
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(240);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };
        Blockly.JavaScript['discord_delete'] = function (block) {
            var value_message = Blockly.JavaScript.valueToCode(block, 'message', Blockly.JavaScript.ORDER_ATOMIC);
            // TODO: Assemble JavaScript into code variable.
            var code = `${value_message}.delete()\n`;
            return code;
        };
        Blockly.Blocks['idtovalue'] = {
            init: function () {
                this.appendValueInput("NAME")
                    .setCheck(null)
                    .appendField("ID:");
                this.appendDummyInput()
                    .appendField("를 가진")
                    .appendField(new Blockly.FieldDropdown([["채널", "channel"], ["사용자", "user"], ["메시지", "message"]]), "NAME");
                this.setInputsInline(true);
                this.setOutput(true, null);
                this.setColour(240);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };
        Blockly.JavaScript['idtovalue'] = function (block) {
            var value_name = Blockly.JavaScript.valueToCode(block, 'NAME', Blockly.JavaScript.ORDER_ATOMIC);
            var dropdown_select = block.getFieldValue('select');
            // TODO: Assemble JavaScript into code variable.
            if (dropdown_select == 'channel')
                var code = `client.channels.cache.get(${value_name})`;
            else if (dropdown_select == 'user')
                var code = `client.users.cache.get(${value_name})`;
            else if (dropdown_select == 'message')
                var code = `client.messages.cache.get(${value_name})`;
            // TODO: Change ORDER_NONE to the correct strength.
            return [code, Blockly.JavaScript.ORDER_NONE];
        };
    </script>
    <style>
        body {
            margin: 0;
            padding: 0;
            height: 100vh;
            width: 100%;
        }

        .main {
            width: 100%;
            height: 100%;
        }

        .middle {
            height: 100%;
            width: 100%;
        }

        #blocklyDiv {
            width: 50%;
            height: 95%;
            float: left;
        }

        #codeDiv {
            width: 50%;
            height: 95%;
            float: right;
            background: #000000
        }

        path {
            bottom: 0;
            height: 50%;
        }
    </style>
</head>

<body>
    <script>
        function saveWorkspace() {
            var xmlDom = Blockly.Xml.workspaceToDom(Blockly.mainWorkspace);
            var xmlText = Blockly.Xml.domToPrettyText(xmlDom);
            localStorage.setItem("blockly.xml", xmlText);
        }
        function loadWorkspace() {
            var xmlText = localStorage.getItem("blockly.xml");
            if (xmlText) {
                Blockly.mainWorkspace.clear();
                xmlDom = Blockly.Xml.textToDom(xmlText);
                Blockly.Xml.domToWorkspace(Blockly.mainWorkspace, xmlDom);
            }
        }
    </script>
    <div class="main">
        <div style="height:5%; display: flex;
        flex-direction: column; /*수직 정렬*/
        align-items:flex-end;
        justify-content: center;
        padding-right: 10px;">
            <div>
                <a class="waves-effect waves-light btn"
                    style="background-color: #5865F2; font-weight: bold; width:100px;height:40px;line-height: 40px;"
                    id="test">Test</a>
                <a class="waves-effect waves-light btn"
                    style="background-color: #5865F2; font-weight: bold; width:100px;height:40px;line-height: 40px;"
                    id="save">Save</a>
            </div>
        </div>
        <!-- 툴 박스 -->
        <xml id="toolbox" style="display: none">
            <category name="Event" colour="220">
                <block type="event_message"></block>
                <block type="event_ready"></block>
                <block type="event_memin"></block>
                <block type="event_memout"></block>
            </category>
            <category name="Act" colour="220">
                <block type="discord_send"></block>
                <block type="discord_edit"></block>
                <block type="discord_delete"></block>
            </category>
            <category name="Properties" colour="220">
                <block type="discoding_message"></block>
                <block type="discoding_user"></block>
                <block type="idtovalue"></block>
            </category>
            <sep></sep>
            <category name="Logic" colour="180">
                <block type="controls_if"></block>
                <block type="logic_compare"></block>
                <block type="logic_operation"></block>
                <block type="logic_negate"></block>
                <block type="logic_boolean"></block>
                <block type="logic_null"></block>
            </category>

            <category name="Loops" colour="60">
                <block type="controls_repeat_ext"></block>
                <block type="controls_whileUntil"></block>
                <block type="controls_flow_statements"></block>
            </category>

            <category name="Math" colour="300">
                <block type="math_number"></block>
                <block type="math_arithmetic"></block>
                <block type="math_single"></block>
                <block type="math_trig"></block>
                <block type="math_constant"></block>
                <block type="math_number_property"></block>
                <block type="math_round"></block>
                <block type="math_on_list"></block>
                <block type="math_modulo"></block>
                <block type="math_constrain"></block>
                <block type="math_random_int"></block>
                <block type="math_random_float"></block>
            </category>

            <category name="Text" colour="160">
                <block type="text"></block>
                <block type="startswith"></block>
                <block type="text_join"></block>
                <block type="text_append"></block>
                <block type="text_length"></block>
                <block type="text_isEmpty"></block>
                <block type="text_indexOf"></block>
                <block type="text_charAt"></block>
                <block type="text_getSubstring"></block>
                <block type="text_changeCase"></block>
                <block type="text_trim"></block>
                <block type="text_print"></block>
                <block type="text_prompt_ext"></block>
            </category>

            <category name="Lists" colour="260">
                <block type="lists_create_with">
                    <mutation items="0"></mutation> <!-- 이게뭐람 -->
                </block>
                <block type="lists_create_with"></block>
                <block type="lists_repeat"></block>
                <block type="lists_length"></block>
                <block type="lists_isEmpty"></block>
                <block type="lists_indexOf"></block>
                <block type="lists_getIndex"></block>
                <block type="lists_setIndex"> </block>
                <block type="lists_getSublist"></block>
                <block type="lists_split"></block>
                <block type="lists_sort"></block>
            </category>
            <category name="Variables" colour="330" custom="VARIABLE"></category>
            <category name="Functions" colour="290" custom="PROCEDURE"></category>
        </xml>
        <!-- 기본 div -->
        <div id="blocklyDiv">
            <script>
                let workspace = Blockly.inject('blocklyDiv', {
                    toolbox: document.getElementById('toolbox'), zoom:
                    {
                        controls: false,
                        wheel: true,
                        startScale: 1.0,
                        maxScale: 2,
                        minScale: 0.2,
                        scaleSpeed: 1.2,
                        pinch: true
                    },
                    trashcan: false
                });
                loadWorkspace()
                workspace.addChangeListener(saveWorkspace);
            </script>
        </div>
        <div id="codeDiv">
            <script>
                let jscode
                document.write("code here".fontcolor("white"))
                var code = Blockly.JavaScript.workspaceToCode(workspace);
                function livecodegen() {
                    var code = `const { Client, Intents } = require('discord.js');
                const client = new Client({ intents: [Intents.FLAGS.GUILDS] });
                const token = "<%= bot_token %>"
                client.login(token);\n` + Blockly.JavaScript.workspaceToCode(workspace);
                    document.getElementById("codeDiv").innerHTML = code.replaceAll("\n", "<br>").fontcolor("white")
                    jscode = code;
                };
                workspace.addChangeListener(livecodegen);
                function Copytest() {
                    navigator.clipboard.writeText(Blockly.JavaScript.workspaceToCode(workspace));
                }
            </script>
        </div>
    </div>

    <script>
        let testbtn = document.getElementById("test")
        let savebtn = document.getElementById("save")

        testbtn.addEventListener('click', () => {
            let xhr = new XMLHttpRequest()
            xhr.open('POST', '/bot/test_bot');
            xhr.setRequestHeader("Content-Type", "application/json")
            xhr.onreadystatechange = () => {
                if (xhr.status === 200 && xhr.readyState === 4) {
                    console.log('good')
                }
            }
            xhr.send(JSON.stringify({
                code: jscode
            }))
        })
    </script>
</body>

</html>